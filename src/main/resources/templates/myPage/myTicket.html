<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<head>
    <title>QuickTicket - 예매 상세정보</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/myPage.css}">
</head>
<body>
    <main layout:fragment="content">
        <div class="page-wrapper">
            <div class="main-container">
                <h2 class="page-title" style="border-bottom:none;">예매 상세정보</h2>

                <section class="detail-layout top-section">
                    <div class="poster-area">
                        <img th:src="@{/images/concertImage5.png}" alt="poster">
                    </div>
                    <div class="info-area">
                        <h3 class="sub-title">공연 정보</h3>
                        <div class="gray-box">
                            <div class="info-row">
                                <span class="label">공연명</span>
                                <span id="eventName" class="value">[[${ticket?.event?.name ?: ''}]]</span>
                            </div>
                            <div class="info-row">
                                <span class="label">공연일자</span>
                                <span id="startsAt" class="value">
                                [[${ticket?.performance?.performanceStartsAt != null ? #temporals.format(ticket.performance.performanceStartsAt, 'yyyy-MM-dd / a hh:mm') : ''}]]
                            </span>
                            </div>
                            <div class="info-row">
                                <span class="label">회차</span>
                                <span id="nth" class="value">[[${ticket?.performance?.nth ?: ''}]]회차</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="detail-layout seat-section">
<!--                    <object id="seatMap" type="image/svg+xml" th:data="@{/api/files/seatMap/{performanceId}(performanceId=${performance.id})}"></object>-->

                    <div class="seat-info-area" style="width: 100%;">
                        <h3 class="sub-title">좌석 선택 / 결제</h3>
                        <div class="gray-box mb-20">
                            <div class="info-row">
                                <span class="label">희망 좌석</span>
                                <span id="personNumbers" class="value">총 [[${ticket?.personNumber ?: 0}]]석</span>
                            </div>
                            <div class="info-row">
                                <span class="label">좌석 예매 상태</span>
                                <span id="status" class="value text-blue">[[${ticket?.status ?: ''}]]</span>
                            </div>
                            <div class="info-row">
                                <span class="label">결제된 좌석</span>
                                <span id="paidSeatContainer" class="value">
                                [[${ticket?.seatPayments?.size() ?: 0}]]석
                                (
                                <th:block th:each="pay, stat : ${ticket?.seatPayments}">
                                    [[${ticket?.performance?.seats?.get(pay?.paidSeatId)?.name ?: ''}]][[${!stat.last ? ', ' : ''}]]
                                </th:block>
                                )
                            </span>
                            </div>
                            <div class="info-row">
                                <span class="label">좌석별 가격</span>
                                <span id="seatPriceContainer" class="value">
                                <th:block th:each="pay : ${ticket?.seatPayments}">
                                    [[${ticket?.performance?.seats?.get(pay?.paidSeatId)?.name ?: ''}]]: [[${pay?.amount != null ? #numbers.formatInteger(pay.amount, 0, 'COMMA') : 0}]]원<br>
                                </th:block>
                            </span>
                            </div>
                        </div>

                        <h3 class="sub-title">예매 확정 좌석</h3>
                        <div id="confirmedSeatListContainer" class="confirmed-seat-list">
                            <th:block th:each="pay : ${ticket?.seatPayments}">
                                <div class="seat-item-row">
                                    <span class="seat-loc">좌석번호 [[${ticket?.performance?.seats?.get(pay?.paidSeatId)?.name ?: ''}]]</span>
                                    <span class="seat-price">
                                    [[${ticket?.performance?.seats?.get(pay?.paidSeatId)?.seatClass ?: ''}]]
                                    <span class="price">[[${pay?.amount != null ? #numbers.formatInteger(pay.amount, 0, 'COMMA') : 0}]]원</span>
                                </span>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </section>

                <section class="detail-row">
                    <h3 class="sub-title">결제 정보</h3>
                    <div class="gray-box">
                        <div class="info-row">
                            <span class="label">예매번호</span>
                            <span id="ticketId" class="value">RES-[[${ticket?.id ?: ''}]]</span>
                        </div>
                        <div class="info-row">
                            <span class="label">예매일자</span>
                            <span id="reservedAt" class="value">[[${ticket?.createdAt != null ? #temporals.format(ticket.createdAt, 'yyyy-MM-dd / HH:mm:ss') : '-'}]]</span>
                        </div>
                        <div class="info-row">
                            <span class="label">결제수단</span>
                            <span id="paymentMethod" class="value">
                            [[${ticket?.paymentMethod?.methodDetails != null ? ticket.paymentMethod.methodDetails['bankName'] : ''}]]
                        </span>
                        </div>
                        <div class="info-row">
                            <span class="label">결제금액</span>
                            <span id="paymentAmount" class="value text-bold">
                            [[${ticket?.seatPayments != null && !ticket.seatPayments.isEmpty() ? #numbers.formatInteger(ticket.seatPayments[0].amount, 0, 'COMMA') : 0}]]원
                        </span>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <div th:replace="~{reviewPopup :: reviewModal}"></div>

        <script>
            // 리뷰 모달 및 별점
            function openReviewModal() {
                const modal = document.getElementById('reviewModal');
                if(modal) modal.classList.remove('hidden');
            }
            function closeReviewModal() {
                const modal = document.getElementById('reviewModal');
                if(modal) modal.classList.add('hidden');
            }
            function setRating(score) {
                const stars = document.querySelectorAll('#starContainer .star');
                document.getElementById('reviewRating').value = score;
                stars.forEach((star, index) => {
                    if (index < score) {
                        star.classList.remove('fa-regular');
                        star.classList.add('fa-solid');
                        star.style.color = '#333';
                    } else {
                        star.classList.remove('fa-solid');
                        star.classList.add('fa-regular');
                        star.style.color = '#ddd';
                    }
                });
            }
            document.addEventListener('DOMContentLoaded', function() {
                const modal = document.getElementById('reviewModal');
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        if (event.target === this) closeReviewModal();
                    });
                }
            });
        </script>

        <script th:inline="javascript">
            // 임시 데이터 정의
            const tempData = {
                event: { name: "2026 이창섭 단독 콘서트 〈EndAnd〉 - 수원", startsAt: "2026-02-09 / 오후 05:00", nth: "1" },
                ticket: { id: "1234567", personNumber: 3, status: "예매 확정", reservedAt: "2026-01-15 / 14:30:00" },
                payment: { method: "신용카드", status: "결제 완료", amount: "410,000" },
                // 좌석 정보 리스트
                seats: [
                    { name: "VIP석", price: "150,000", list: ["A-12", "A-13"] },
                    { name: "R석", price: "110,000", list: ["C-05"] }
                ]
            };

            const setText = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.innerText = val;
            };

            setText("eventName", tempData.event.name);
            setText("startsAt", tempData.event.startsAt);
            setText("nth", tempData.event.nth + "회차");

            setText("personNumbers", "총 " + tempData.ticket.personNumber + "석");
            setText("status", tempData.ticket.status);
            setText("ticketId", "RES-" + tempData.ticket.id);
            setText("reservedAt", tempData.ticket.reservedAt);

            setText("amount", tempData.payment.amount + "원 (확정)");
            setText("paymentMethod", tempData.payment.method);
            setText("paymentStatus", tempData.payment.status);
            setText("paymentAmount", tempData.payment.amount + "원");

            // 좌석 리스트
            const paidSeatBox = document.getElementById("paidSeatContainer");
            if (paidSeatBox) {
                let summaryText = `${tempData.ticket.personNumber}석 ( `;
                tempData.seats.forEach((seat, idx) => {
                    summaryText += `${seat.name} ${seat.list.length}개`;
                    if (idx < tempData.seats.length - 1) summaryText += ", ";
                });
                summaryText += " )";
                paidSeatBox.innerText = summaryText;
            }

            // 좌석별 가격
            const seatPriceBox = document.getElementById("seatPriceContainer");
            if (seatPriceBox) {
                seatPriceBox.innerHTML = "";
                tempData.seats.forEach(seat => {
                    seatPriceBox.innerHTML += `${seat.name}: ${seat.price}원<br>`;
                });
            }

            // 예매 확정 리스트
            const detailListBox = document.getElementById("confirmedSeatListContainer");
            if (detailListBox) {
                detailListBox.innerHTML = "";

                tempData.seats.forEach(seat => {
                    seat.list.forEach(seatNum => {
                        const html = `
                                <div class="seat-item-row">
                                    <span class="seat-loc">좌석번호 ${seatNum}</span>
                                    <span class="seat-price">
                                        ${seat.name}
                                        <span class="price">${seat.price}원</span>
                                    </span>
                                </div>
                            `;
                        detailListBox.innerHTML += html;
                    });
                });
            }
        </script>
    </main>
</body>
</html>