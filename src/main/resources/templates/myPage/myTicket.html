<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<head>
    <title>QuickTicket - 예매 상세정보</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/myPage.css}">
</head>
<body>
    <main layout:fragment="content">
        <div class="page-wrapper">
            <div class="main-container">

                <h2 class="page-title" style="border-bottom:none;">예매 상세정보</h2>

                <!-- 공연정보 영역 -->
                <section class="detail-layout top-section">
                    <div class="poster-area">
                        <img th:src="@{/images/concertImage5.png}" alt="concert5">
                    </div>

                    <div class="info-area">
                        <h3 class="sub-title">공연 정보</h3>

                        <div class="gray-box">
                            <div class="info-row">
                                <span class="label">공연명</span>
                                <span id="eventName" class="value">[[${event?.name}]]</span>
                            </div>
                            <div class="info-row">
                                <span class="label">공연일자</span>
                                <span id="startsAt" class="value">
                                        [[${event?.startsAt != null ? #temporals.format(event.startsAt, 'yyyy-MM-dd / a hh:mm') : ''}]]
                                    </span>
                            </div>
                            <div class="info-row">
                                <span class="label">회차</span>
                                <span id="nth" class="value">[[${event?.nth}]]회차</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 좌석선택 영역 -->
                <section class="detail-layout seat-section">
                    <div class="map-view-area">
                        <div class="seat-map-area">
                            <div>
                                <p>좌석선택영역입니다.</p>
                            </div>
                        </div>
                        <div class="map-legend">
                            <span class="legend-item"><span class="color-box confirmed"></span> 예매 확정된 좌석</span>
                            <span class="legend-item"><span class="color-box pending"></span> 예매 대기중인 좌석</span>
                        </div>
                    </div>
                    <div class="seat-info-area">
                        <h3 class="sub-title">좌석 선택 / 결제</h3>
                        <div class="gray-box mb-20">
                            <div class="info-row">
                                <span class="label">희망 좌석</span>
                                <span id="personNumbers" class="value">총 [[${ticket?.personNumber}]]석</span>
                            </div>
                            <div class="info-row">
                                <span class="label">좌석 예매 상태</span>
                                <span id="status" class="value text-blue">[[${ticket?.status}]]</span>
                            </div>

                            <div class="info-row">
                                <span class="label">결제된 좌석</span>
                                <span id="paidSeatContainer" class="value">
                                        [[${ticket?.personNumber}]]석
                                        (
                                        <th:block th:each="info, stat : ${seatInfoList}">
                                            [[${info?.name}]] [[${info?.wishingSeatsId?.size()}]]개[[${!stat.last ? ', ' : ''}]]
                                        </th:block>
                                        )
                                    </span>
                            </div>

                            <div class="info-row">
                                <span class="label">좌석별 가격</span>
                                <span id="seatPriceContainer" class="value">
                                        <th:block th:each="info : ${seatInfoList}">
                                            [[${info?.name}]]: [[${info?.price != null ? #numbers.formatInteger(info.price, 0, 'COMMA') : 0}]]원<br>
                                        </th:block>
                                    </span>
                            </div>
                        </div>

                        <h3 class="sub-title">예매 확정 좌석</h3>
                        <div id="confirmedSeatListContainer" class="confirmed-seat-list">
                            <th:block th:each="info : ${seatInfoList}">
                                <div class="seat-item-row" th:each="seatId : ${info?.wishingSeatsId}">
                                    <span class="seat-loc">좌석번호 [[${seatId}]]</span>
                                    <span class="seat-price">
                                            [[${info?.name}]]
                                            <span class="price">[[${info?.price != null ? #numbers.formatInteger(info.price, 0, 'COMMA') : 0}]]원</span>
                                        </span>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </section>

                <!-- 예매 정보 영역 -->
                <section class="detail-row">
                    <h3 class="sub-title">예매 정보</h3>
                    <div class="gray-box">
                        <div class="info-row">
                            <span class="label">예매번호</span>
                            <span id="ticketId" class="value">[[ 'RES-' + ${ticket?.id} ]]</span>
                        </div>
                        <div class="info-row">
                            <span class="label">예매일자</span>
                            <span id="reservedAt" class="value">[[${ticket?.reservedAt != null ? #temporals.format(ticket.reservedAt, 'yyyy-MM-dd / HH:mm:ss') : '-'}]]</span>
                        </div>
                        <div class="info-row">
                            <span class="label">결제 예상 범위</span>
                            <span id="amount" class="value">
                                    [[${payment?.amount != null ? #numbers.formatInteger(payment.amount, 0, 'COMMA') : 0}]]원 (확정)<br>
                                    <span class="sub-text">※ 취소표 발생 시 가장 먼저 매칭된 좌석의 금액으로 자동 결제됩니다.</span>
                                </span>
                        </div>
                    </div>
                </section>

                <!-- 결제 정보 영역 -->
                <section class="detail-row">
                    <h3 class="sub-title">결제 정보</h3>
                    <div class="gray-box">
                        <div class="info-row">
                            <span class="label">결제수단</span>
                            <span id="paymentMethod" class="value">[[${payment?.method}]]</span>
                        </div>
                        <div class="info-row">
                            <span class="label">결제 상태</span>
                            <span id="paymentStatus" class="value text-bold">[[${payment?.status}]]</span>
                        </div>
                        <div class="info-row">
                            <span class="label">결제금액</span>
                            <span id="paymentAmount" class="value text-bold">[[${payment?.amount != null ? #numbers.formatInteger(payment.amount, 0, 'COMMA') : 0}]]원</span>
                        </div>
                    </div>
                </section>

                <div class="form-footer-buttons">
                    <button class="btn-submit" style="width: 110px;" onclick="openReviewModal()">감상평 등록</button>
                    <a th:href="@{/cancelTicketSuccess}" class="btn-list" style="width: 110px;">등록취소</a>
                </div>
            </div>
        </div>

        <div th:replace="~{reviewPopup :: reviewModal}"></div>

        <script>
            // 리뷰 모달 및 별점
            function openReviewModal() {
                const modal = document.getElementById('reviewModal');
                if(modal) modal.classList.remove('hidden');
            }
            function closeReviewModal() {
                const modal = document.getElementById('reviewModal');
                if(modal) modal.classList.add('hidden');
            }
            function setRating(score) {
                const stars = document.querySelectorAll('#starContainer .star');
                document.getElementById('reviewRating').value = score;
                stars.forEach((star, index) => {
                    if (index < score) {
                        star.classList.remove('fa-regular');
                        star.classList.add('fa-solid');
                        star.style.color = '#333';
                    } else {
                        star.classList.remove('fa-solid');
                        star.classList.add('fa-regular');
                        star.style.color = '#ddd';
                    }
                });
            }
            document.addEventListener('DOMContentLoaded', function() {
                const modal = document.getElementById('reviewModal');
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        if (event.target === this) closeReviewModal();
                    });
                }
            });
        </script>

        <script th:inline="javascript">
            // 임시 데이터 정의
            const tempData = {
                event: { name: "2026 이창섭 단독 콘서트 〈EndAnd〉 - 수원", startsAt: "2026-02-09 / 오후 05:00", nth: "1" },
                ticket: { id: "1234567", personNumber: 3, status: "예매 확정", reservedAt: "2026-01-15 / 14:30:00" },
                payment: { method: "신용카드", status: "결제 완료", amount: "410,000" },
                // 좌석 정보 리스트
                seats: [
                    { name: "VIP석", price: "150,000", list: ["A-12", "A-13"] },
                    { name: "R석", price: "110,000", list: ["C-05"] }
                ]
            };

            const setText = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.innerText = val;
            };

            setText("eventName", tempData.event.name);
            setText("startsAt", tempData.event.startsAt);
            setText("nth", tempData.event.nth + "회차");

            setText("personNumbers", "총 " + tempData.ticket.personNumber + "석");
            setText("status", tempData.ticket.status);
            setText("ticketId", "RES-" + tempData.ticket.id);
            setText("reservedAt", tempData.ticket.reservedAt);

            setText("amount", tempData.payment.amount + "원 (확정)");
            setText("paymentMethod", tempData.payment.method);
            setText("paymentStatus", tempData.payment.status);
            setText("paymentAmount", tempData.payment.amount + "원");

            // 좌석 리스트
            const paidSeatBox = document.getElementById("paidSeatContainer");
            if (paidSeatBox) {
                let summaryText = `${tempData.ticket.personNumber}석 ( `;
                tempData.seats.forEach((seat, idx) => {
                    summaryText += `${seat.name} ${seat.list.length}개`;
                    if (idx < tempData.seats.length - 1) summaryText += ", ";
                });
                summaryText += " )";
                paidSeatBox.innerText = summaryText;
            }

            // 좌석별 가격
            const seatPriceBox = document.getElementById("seatPriceContainer");
            if (seatPriceBox) {
                seatPriceBox.innerHTML = "";
                tempData.seats.forEach(seat => {
                    seatPriceBox.innerHTML += `${seat.name}: ${seat.price}원<br>`;
                });
            }

            // 예매 확정 리스트
            const detailListBox = document.getElementById("confirmedSeatListContainer");
            if (detailListBox) {
                detailListBox.innerHTML = "";

                tempData.seats.forEach(seat => {
                    seat.list.forEach(seatNum => {
                        const html = `
                                <div class="seat-item-row">
                                    <span class="seat-loc">좌석번호 ${seatNum}</span>
                                    <span class="seat-price">
                                        ${seat.name}
                                        <span class="price">${seat.price}원</span>
                                    </span>
                                </div>
                            `;
                        detailListBox.innerHTML += html;
                    });
                });
            }
        </script>
    </main>

</body>
</html>