<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<head>
    <title>QuickTicket - 콘서트 관리</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<main layout:fragment="content">
    <div class="page-wrapper">
        <div class="main-container">
            <form class="search-filter-box">
                <div class="filter-group">
                    <span class="filter-label">공연기간</span>
                    <div style="position: relative;">
                        <input type="text" id="datePicker" class="form-input date-wrapper"
                               style="background-color: #ffffff;"
                               th:value="${(condition?.startDate != null and condition?.startDate != '') ? condition.startDate + ' ~ ' + condition.endDate : '전체'}"
                               placeholder="날짜 선택">
                        <i class="fa-regular fa-calendar" id="calendarIcon" style="position: absolute; right: 10px; top: 12px; color: #999; cursor: pointer;"></i>
                    </div>
                </div>

                <div class="filter-group">
                    <span class="filter-label">카테고리</span>
                    <select class="form-select custom-select" name="category">
                        <option value="">전체</option>
                        <option value="1" th:selected="${condition?.category == '1'}">콘서트</option>
                        <option value="2" th:selected="${condition?.category == '2'}">뮤지컬</option>
                        <option value="3" th:selected="${condition?.category == '3'}">연극</option>
                        <option value="4" th:selected="${condition?.category == '4'}">해외뮤지션</option>
                        <option value="5" th:selected="${condition?.category == '5'}">KIDS</option>
                    </select>
                </div>

                <!--
                <div class="filter-group">
                    <span class="filter-label">상태</span>
                    <select class="form-select custom-select">
                        <option value="">전체</option>
                        <option value="SALE">판매중</option>
                        <option value="SOLD_OUT">매진</option>
                    </select>
                </div>
                -->

                <div class="filter-group">
                    <span class="filter-label">검색어</span>
                    <input type="text" class="form-input keyword-input" th:value="${condition?.keyword}"
                           placeholder="검색어를 입력하세요">
                </div>

                <button type="button" class="btn-search">검색</button>
            </form>
            <div class="list-header">
                <div class="sub-title">콘서트 목록</div>
                <div class="btn-group">
                    <a th:href="@{/newEvent}" class="btn-register">등록</a>
                    <a href="javascript:void(0);" class="btn-delete" id="btnDelete">삭제</a>
                </div>
            </div>

            <div class="table-container">
                <table class="common-table">
                    <thead>
                        <tr>
                            <th class="col-check" style="text-align: center">
                                <input type="checkbox" id="checkAll">
                            </th>
                            <th style="width: 3%;">NO</th>
                            <th style="width: 7%;">썸네일</th>
                            <th style="width: 10%;">카테고리</th>
                            <th style="width: 25%;">공연명</th>
                            <th style="width: 20%;">출연자</th>
                            <th style="width: 15%;">공연장소</th>
                            <th style="width: 10%;">연령</th>
                            <th style="width: 10%;">공연날짜</th>
                        </tr>
                    </thead>
                    <tbody id="eventListContainer">
                        <tr th:each="event, stat : ${eventList}" th:id="'event-row-' + ${stat.count}">
                            <td style="text-align: center;">
                                <input type="checkbox" class="child-check" th:value="${event.eventId}">
                            </td>
                            <td th:text="${(page.number * page.size) + stat.count}">NO</td>
                            <td>
                                <div class="thumb-box">
                                    <img th:if="${event.eventId != null}"
                                         th:src="@{/api/images/event/{id}(id=${event.eventId})}"
                                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;"
                                         onerror="this.style.display='none';">

                                    <div th:unless="${event.eventId != null}"
                                         style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                        <i class="fa-regular fa-image" style="color: #ccc;"></i>
                                    </div>
                                </div>
                            </td>
                            <td>
                                [[${event?.category1Name ?: ''}]]
<!--                                [[${event?.category2Name != null ? ' > ' + event.category2Name : ''}]]-->
                            </td>
                            <td>
                                <a th:href="@{/editEvent/{eventId}(eventId=${event.eventId})}" class="link-title">
                                    [[${event?.name ?: '-'}]]
                                </a>
                            </td>
                            <td>[[${event?.cast ?: '-'}]]</td>
                            <td>[[${event?.locationName ?: '장소 미정'}]]</td>
                            <td>
                                <span class="status-tag">
                                    [[${event?.ageRating?.description ?: '미지정'}]]
                                </span>
                            </td>
                            <td th:text="${#temporals.format(event.performanceStartsAt, 'yyyy.MM.dd')}">
                                2026.02.15
                            </td>
<!--                            <td style="text-align: center; cursor: pointer; color: #999;">-->
<!--                                <i class="fa-solid fa-ellipsis-vertical"></i>-->
<!--                            </td>-->
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" th:if="${page.totalPages > 0}">
                <a th:href="@{/admin/event(page=0, startDate=${condition.startDate}, endDate=${condition.endDate}, category=${condition.category}, keyword=${condition.keyword})}"
                   class="page-btn"><i class="fa-solid fa-angles-left"></i></a>

                <a th:if="${page.hasPrevious()}"
                   th:href="@{/admin/event(page=${page.number - 1}, startDate=${condition.startDate}, endDate=${condition.endDate}, category=${condition.category}, keyword=${condition.keyword})}"
                   class="page-btn"><i class="fa-solid fa-angle-left"></i></a>

                <th:block th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}">
                    <a th:href="@{/admin/event(page=${i}, startDate=${condition.startDate}, endDate=${condition.endDate}, category=${condition.category}, keyword=${condition.keyword})}"
                       th:text="${i + 1}"
                       class="page-btn"
                       th:classappend="${i == page.number} ? 'active' : ''">1</a>
                </th:block>

                <a th:if="${page.hasNext()}"
                   th:href="@{/admin/event(page=${page.number + 1}, startDate=${condition.startDate}, endDate=${condition.endDate}, category=${condition.category}, keyword=${condition.keyword})}"
                   class="page-btn"><i class="fa-solid fa-angle-right"></i></a>

                <a th:href="@{/admin/event(page=${page.totalPages - 1}, startDate=${condition.startDate}, endDate=${condition.endDate}, category=${condition.category}, keyword=${condition.keyword})}"
                   class="page-btn"><i class="fa-solid fa-angles-right"></i></a>
            </div>

        </div>
    </div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('datePicker');
            const dateValue = dateInput.value;

            // Flatpickr 초기설정
            const picker = flatpickr("#datePicker", {
                mode: "range",
                dateFormat: "Y.m.d",
                locale: "ko",
                conjunction: " ~ ",
                // defaultDate를 설정하지 않거나, 이미 값이 있을 때(검색 후)만 유지하도록 변경
                defaultDate: (dateValue && dateValue !== '전체') ? dateValue.split(" ~ ") : null
            });

            // 아이콘 클릭 시 달력 열기
            document.getElementById('calendarIcon').addEventListener('click', () => {
                picker.open();
            });

            // 검색 버튼 클릭 시
            document.querySelector('.btn-search').addEventListener('click', function() {
                const dateRange = dateInput.value;
                let startDate = "";
                let endDate = "";

                // "전체"가 아니거나 빈 값이 아닐 때만 날짜 파싱해줌
                if (dateRange && dateRange !== '전체') {
                    const dates = dateRange.split(" ~ ");
                    startDate = dates[0] || "";
                    endDate = dates[1] || dates[0] || "";
                }

                const category = document.querySelector('.custom-select').value;
                const keyword = document.querySelector('.keyword-input').value;

                location.href = `/admin/event?page=0&startDate=${startDate}&endDate=${endDate}&category=${category}&keyword=${encodeURIComponent(keyword)}`;
            });


            const checkAll = document.getElementById('checkAll');
            const childChecks = document.querySelectorAll('.child-check');
            const btnDelete = document.getElementById('btnDelete');

            // 전체 선택/해제
            checkAll.addEventListener('change', function() {
                childChecks.forEach(check => {
                    check.checked = this.checked;
                });
            });

            // 개별 체크박스 클릭 시 전체 체크박스에도 체크가 되도록함
            childChecks.forEach(check => {
                check.addEventListener('change', function() {
                    const allChecked = document.querySelectorAll('.child-check:checked').length === childChecks.length;
                    checkAll.checked = allChecked;
                });
            });

            // 삭제 버튼 클릭 시 이벤트 내부
            btnDelete.addEventListener('click', function() {
                const checkedItems = document.querySelectorAll('.child-check:checked');
                const arrDelete = Array.from(checkedItems).map(item => item.value);

                if (arrDelete.length === 0) {
                    alert('삭제할 항목을 선택해주세요.');
                    return;
                }

                if (confirm(`선택한 ${arrDelete.length}개의 항목을 삭제하시겠습니까?`)) {

                    //  메타 태그에서 CSRF 토큰과 헤더 이름을 가져옴
                    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    fetch('/api/admin/events/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [header]: token
                        },
                        body: JSON.stringify(arrDelete)
                    })
                        .then(response => {
                            if (response.ok) {
                                alert('삭제되었습니다.');
                                location.reload();
                            } else {
                                alert('삭제에 실패했습니다. (상태코드: ' + response.status + ')');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('오류가 발생했습니다.');
                        });
                }
            });
        });
    </script>
</main>

</body>
</html>